# Security Standards & Mandatory Checklist

**Last Updated:** 2026-02-22
**Authority:** This document is the single source of truth for all security requirements.
**Scope:** Every endpoint, entity, service, and frontend component in this project.

> [!CAUTION]
> Security is not optional. The agent MUST run the Security Review Checklist (Section 4) before marking any feature as done. Skipping any item requires explicit user approval with a documented reason.

---

## 1. The 5 Security Pillars (Always Active)

| Pillar | Rule |
|---|---|
| **Authentication** | Every protected endpoint must have `@UseGuards(JwtAuthGuard)`. No exceptions. |
| **Authorization** | Every admin/sensitive endpoint must verify `companyId` from token AND check `@Roles()`/`@RequirePermission()`. |
| **Input Validation** | Every POST/PATCH/DELETE must have a DTO with `class-validator` decorators. Never trust raw `req.body`. |
| **Data Isolation** | Every DB query on a tenant-scoped entity must include `where: { companyId }`. Super Admins are the only bypass. |
| **Secrets** | Zero hardcoded credentials, tokens, or API keys. All via `ConfigService` + `.env`. |

---

## 2. Specific Security Rules by Area

### 2a. API Endpoints
```typescript
// ✅ Every admin endpoint must look like this:
@Get('/:id')
@UseGuards(JwtAuthGuard, RolesGuard)           // 1. Authenticated
@Roles('admin', 'superAdmin')                  // 2. Authorized
async getOne(
  @Param('id') id: string,
  @CurrentTenant() companyId: string,          // 3. Tenant-scoped
) {
  const record = await this.service.findOne(id, companyId); // 4. DB filter includes companyId
  if (!record) throw new NotFoundException();  // 5. 404, not 403 (don't leak existence)
  return record;
}
```

**Rules:**
- Return `404 NotFoundException` (not `403`) when a tenant tries to access another tenant's resource — never confirm the resource exists
- NEVER skip `companyId` in the `where` clause even for Super Admin routes unless the endpoint is explicitly site-wide
- Rate-limit authentication endpoints (`/auth/login`, `/auth/refresh`) with `@Throttle()`

---

### 2b. PII & Sensitive Data Handling

> [!IMPORTANT]
> This project stores personally identifiable information (phone numbers, emails, real names). Treat ALL of the following as PII: email, phone/mobile, name, IC/passport number, bank account number, balance history.

**Storage Rules:**
- PII fields MUST be encrypted at rest using the `EncryptionTransformer` (see `encryption.transformer.ts`)
- A `hash` column (e.g., `emailHash`, `mobileHash`) MUST exist alongside encrypted fields for search/uniqueness
- Raw PII MUST NEVER appear in: API list responses, log files, error messages, or audit trails

**Response Rules:**
```typescript
// ✅ In list responses — masked:
{ email: '****@gmail.com', mobile: '+60 **** 1234' }

// ✅ In detail responses — only if role permits:
@RequirePermission('members:view_sensitive')
async getDetail() { return fullRecord; }

// ❌ BANNED — never in logs:
this.logger.log(`Processing user ${user.email}`); // PII in logs!
```

---

### 2c. File Upload Security

Every file upload endpoint MUST enforce ALL of the following:

```typescript
// In the Multer config:
const upload = multer({
  limits: { fileSize: 5 * 1024 * 1024 },               // ✅ Max 5MB
  fileFilter: (req, file, cb) => {
    const allowed = ['image/jpeg', 'image/png', 'image/webp', 'audio/mpeg'];
    if (!allowed.includes(file.mimetype)) {
      cb(new BadRequestException({ code: 'INVALID_FILE_TYPE' }), false);
    } else { cb(null, true); }
  },
});
```

**Path Traversal Prevention (mandatory for delete endpoints):**
```typescript
// Before any fs.unlink() call:
const safePath = path.resolve(uploadDir, filename);
if (!safePath.startsWith(path.resolve(uploadDir))) {
  throw new ForbiddenException('Invalid path');  // Path traversal attempt
}
```

**Rules:**
- Filenames generated by the server (UUID), NEVER from user input
- Files stored outside the web root (`uploads/` served via static, not directly)
- Old files MUST be physically deleted on replacement (see MEMORY_BANK Pattern #8)

---

### 2d. Authentication & Session Security

| Item | Standard |
|---|---|
| JWT Access Token | Short-lived: 15 minutes |
| JWT Refresh Token | 7 days, stored in `httpOnly` cookie |
| Password Hashing | `bcrypt` with cost factor ≥ 12 |
| Failed Login | Rate-limited: max 5 attempts per minute per IP |
| Token Rotation | Refresh token is rotated on every use |
| Token Storage (Frontend) | Access token in memory only (NOT localStorage) |

---

### 2e. Database Security

```typescript
// ✅ ALWAYS use TypeORM parameterized queries:
.where('user.email = :email', { email })          // Safe
.where(`user.email = '${email}'`)                 // ❌ SQL INJECTION

// ✅ ALWAYS add DB constraints, not just code checks:
@Column({ unique: true })                         // Uniqueness enforced in DB
@Index(['companyId', 'email'])                    // Performance + scoping

// ✅ ALWAYS use onDelete cascade for child entities:
@ManyToOne(() => Company, { onDelete: 'CASCADE' })
```

---

### 2f. Frontend Security

**XSS Prevention:**
```vue
<!-- ✅ Safe — Vue auto-escapes -->
<span>{{ userInput }}</span>

<!-- ❌ DANGEROUS — never use v-html with user data -->
<div v-html="userContent" />
```

**API Token Handling:**
```typescript
// ✅ Store JWT in memory (Pinia store), not localStorage
const authStore = useAuthStore();
authStore.token = response.data.token;

// ❌ NEVER:
localStorage.setItem('token', response.data.token); // XSS vulnerable
```

**postMessage (Game iframe) Validation:**
```typescript
window.addEventListener('message', (event) => {
  // ✅ ALWAYS validate origin first
  const allowedOrigins = [import.meta.env.VITE_API_BASE_URL];
  if (!allowedOrigins.includes(event.origin)) return; // Silently ignore
  if (!event.data?.type) return;                       // Validate structure
  handleMessage(event.data);
});
```

---

### 2g. Webhooks & External Integrations

```typescript
// ✅ ALWAYS verify webhook signatures:
function verifySignature(payload: string, signature: string, secret: string): boolean {
  const expected = crypto.createHmac('sha256', secret).update(payload).digest('hex');
  return crypto.timingSafeEqual(Buffer.from(signature), Buffer.from(`sha256=${expected}`));
}

// In the controller:
@Post('/webhook')
async handleWebhook(@Headers('x-signature') sig: string, @RawBody() body: Buffer) {
  const secret = this.config.get('WEBHOOK_SECRET');
  if (!verifySignature(body.toString(), sig, secret)) {
    throw new UnauthorizedException('Invalid signature');
  }
  // Process only after signature verified
}
```

---

## 3. Logging & Audit Trail Security

**Mandatory Audit Log entries** (anything sensitive must be recorded):
- User login / logout
- Failed login attempts
- Role / permission changes
- Impersonation start / end
- Prize award or credit deduction
- PII access (viewing unmasked member details)

**What MUST NEVER appear in logs:**
- Passwords (even hashed)
- JWT tokens or API keys  
- Full PII (use masked version: `user#${userId}` not `user email`)
- Full credit card / bank account numbers

---

## 4. Mandatory Security Review Checklist

> [!IMPORTANT]
> Run this checklist before EVERY feature is merged. This is not optional.

### Before Writing Code
- [ ] Does this endpoint expose any data to unauthorized users?
- [ ] Does this touch PII? If yes → have you applied encryption + masking?
- [ ] Does this accept file uploads? If yes → MIME check + size limit + path traversal guard required.
- [ ] Does this call an external API? If yes → webhook signature verification required.

### Backend Security Gate
- [ ] All endpoints have `@UseGuards(JwtAuthGuard)` (unless explicitly public)
- [ ] All tenant-scoped queries include `where: { companyId }`
- [ ] All DTOs use `class-validator` — no raw `req.body` is trusted
- [ ] No secrets hardcoded — all from `ConfigService`
- [ ] No PII in log statements
- [ ] File uploads: MIME type validated, filename server-generated, path traversal protected
- [ ] Destructive operations use DB transactions

### Frontend Security Gate
- [ ] No `v-html` used with dynamic/user-generated content
- [ ] JWT stored in memory (Pinia store), not `localStorage`
- [ ] `postMessage` handlers validate `event.origin` before processing
- [ ] No sensitive data exposed in browser console logs

### Infrastructure Gate
- [ ] New `.env` variables documented in `.env.example` (value redacted)
- [ ] No credentials committed to git (run `git diff` and check)
- [ ] New Docker services do not expose unnecessary ports

---

## 5. Known Security Decisions (Reference)

See `docs/ARCHITECTURE_DECISIONS.md` for context on:
- **AD-003** — `emailHash` unique key (PII protection)
- **AD-005** — Physical file delete on replacement (storage security)
- **AD-008** — `companyId` required on all entities (tenant isolation)
